## Context Manager protocol(컨텍스트 관리 프로토콜)

[before_context_applied.py](./before_context_applied.py)를 with 문과 연결할 수 있도록 고치는 작업을 이번 장에서 할 것이다. 

`프로토콜`이란 반드시 지켜야 하는 합의된 절차 또는 규칙 집합을 말한다. 

그 전에 `컨텍스트 관리 프로토콜`을 준수하는 방법을 확인하자. 

1. 표준 라이브러리의 contextlib 모듈을 활용해서 간단하게 컨텍스트 관리 프로토콜을 만드는 방법
2. DB 연결 등 with로 외부 객체를 제어해야 하는 상황에서 프로토콜을 준수하는 클래스를 만드는 방법

여기서는 2번이 올바른 방법이다. 그렇다면 `컨텍스트 관리 프로토콜을 준수`한다는 건 뭘 의미하는 걸까? 

### 메서드로 컨텍스트 관리하기 

`컨텍스트 관리 프로토콜`을 준수하는 모든 클래스는 두 가지 요술 메서드를 정의해야 한다.
`__enter__`와 `__exit__` 두 개를 정의해야 한다. 

이 프로토콜을 준수하도록 클래스를 구현하면 with문과 연결할 수 있다. 

#### __enter__는 설정을 담당 

객체에 with문을 사용할 때 인터프리터는 with문의 suite를 시작하기 전에 `객체의 __enter__` 메서드를 호출한다. 
따라서, `__enter__` 내에서 필요한 설정 작업을 수행할 수 있다. 

프로토콜은 `__enter__`가 with문에 반환값을 제공할 수 있음(선택사항)을 명시한다. 

#### __exit__는 마무리를 담당 

with문의 suite가 끝나면 인터프리터는 항상 `객체의 __exit__` 메서드를 호출한다. 
따라서, `__exit__` 메서드에서 필요한 마무리 작업을 수행할 수 있다. 

with문의 suite가 예외 발생 등으로 정상적으로 동작하지 않을 수 있으므로 여러 상황에 대비할 수 있도록 `__exit__` 메서드를 구현해야 한다. 

자, `__enter__`와 `__exit__` 메서드를 클래스에 정의했다면 인터프리터는 자동으로 해당 클래스를 컨텍스트 관리자로 인식하여 with문과 연결할 수 있게 된다. 즉, 컨텍스트 관리 프로토콜을 준수하고 컨텍스트 관리자를 구현하는 클래스를 완성하는 것이다. 

### 이전에 사용했던 코드로 컨텍스트 관리자가 어떻게 동작하는지 살펴보자.

- 아래 코드에서 `__enter__`, `__exit__`, `__init__`이 어디에 호출되었는지 살펴보자.

```
# 1. 인터프리터가 with문을 만났을 때 open과 연관된 __init__을 호출함 
# 2. __init__을 실행하고 나서 open 메소드의 호출 결과가 tasks 변수에 할당되도록 인터프리터가 __enter__를 호출함 
with open('todos.txt') as tasks : 
    for chors in tasks : 
        print(chore, end = '')

# 3. with문이 끝나면 마무리 작업을 수행하도록 인터프리터가 __exit__을 호출함 
# 여기서는 인터프리터에 의해 열린 파일이 모두 닫힘 
```

#### __enter__ 메소드 구현 
`__enter__` 메서드는 with문의 suite를 실행하기 전에 필요한 설정 코드를 수행할 수 있는 기회를 제공한다. 

기존 코드 부분 
```
conn = mysql.connector.connect(**dbconfig)
cursor = conn.cursor() 
```

위 코드를 보면 MySQL 연결을 위한 딕셔너리를 이용해서 DB와 연결한 다음 
그 연결을 가지고 커서를 만들었다. 

즉, DB로 명령을 전달하는 코드를 구현할 때 마다 이러한 설정 작업을 해줘야 한다. 
그렇다는 건 `__enter__` 메소드를 구현할 때 저 설정작업 내용을 넣어주면 되겠다.

```
def __enter__(self) -> 'cursor' : 
        self.conn = mysql.connector.connect(**self.configuration)
        self.cursor = self.conn.cursor()
        
        return self.cursor
```

이미 생성자를 통해 전달받은 내용을 가지고 `연결(conn)`을 만들고 `커서(cursor)`를 만들어서 반환한다. 

#### __exit__ 메소드 구현 

`__exit__` 메서드는 with문이 끝났을 때 수행할 마무리 코드를 실행한다. 

- 기존 코드의 마무리 부문 
```
conn.commit()
cursor.close()
conn.close()
```

실행 순서를 정리하면 다음과 같다. 
1. 데이터베이스로 커밋
2. 커서 닫기
3. 데이터베이스 연결 닫기

DB로 어떤 작업을 수행할 때 마다 이 코드들이 필요하니까 3개 행의 코드를 `__exit__`로 옮겨서 컨택스트 관리자 클래스에 기능을 추가하자.

```
# 에러가 발생했을 때 3개의 인자를 전달한다.
# 이에 관해서는 좀 더 뒤에서 다루도록 하자. 
def __exit__(self, exc_type, exc_value, exc_trace) -> None: 
        
        self.conn.commit()
        self.cursor.close()
        self.conn.close()
```
