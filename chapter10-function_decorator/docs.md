## 함수 장식자(Function decorator)

장식자 : 기존 함수의 코드를 변경하지 않고 함수에 코드를 추가할 수 있는 기법

이번 장에서는 고급 기법에 해당하는 `함수 장식자`를 쉽게 만들어서 사용할 수 있는 방법에 대해서 설명한다.

### 현재 작동하고 있는 웹앱은 모든 사용자에게 열려있다. 

현재는 `/viewlog` URL을 알고 있다면 누구나 로그 기록을 볼 수 있도록 되어 있다. 

여기에 접근 권한을 부여해서 특정 사용자만 접속하도록 할 수는 없을까? 

### 인증된 사용자만 접근하도록 하기 

생각처럼 간단하지 않다. 웹이 작동하는 방식때문에 일이 좀 복잡하다. 이 문제를 해결하기 이전에 어떤 문제가 있고 어떻게 해결해야 하는지 살펴보자. 

### stateless HTTP 

### 웹 앱의 상태를 전역 변수에 저장할 때 발생하는 문제점

1. 웹 서버는 작성한 웹앱의 코드를 언제든지 메모리에서 해제할 수 있기 때문에 전역 변수에 저장된 값이 사라질 수 있다. 
- 즉, True가 저장되어 있다고 생각했지만 사실 False가 저장되어 있을 가능성이 존재

2. 서로 다른 사용자가 전역변수에 접근할 때 이에 따른 동기화 문제가 발생한다. 

때문에 일반적으로 웹앱의 상태를 `전역변수에 저장`하는 건 `좋은 방법이 아니다`.

### 세션(Session)

- 전역변수를 사용하지 않고 변수를 저장하는 방법
- 각각의 사용자 데이터가 서로 간섭받지 않도록 유지하는 방법 

대부분의 웹앱 개발 프레임워크는 두 가지 요구사항을 해결하기 위해 `세션(Session)`이라는 기술을 제공한다. 

Flask는 브라우저에 `쿠키`라는 식별 정보를 추가한 다음 이 정보를 `웹 서버의 세션ID`라는 식별 정보와 연결하는 방식으로 세션 기술을 사용한다. 

ex) quick_session.py 

여기서 알아볼 내용은 웹앱이 세션 데이터를 저장하고 가져올 수 있는지 확인하려고 하는 것이다. 또한 사용자 간의 정보가 간섭되지는 않는지 확인해야 한다. 

이를 테스트하려면 여러 브라우저로 여러 사용자가 웹앱을 사용하는 상황을 재현해야 한다. 하지만, 웹 서버는 상태(state)를 저장하지 않기 때문에 하나의 컴퓨터에서 여러 브라우저를 실행하더라도 개별적인 연결로 취급해서 문제가 없다. 

즉, 3대의 컴퓨터가 각 브라우저에서 서로 다른 URL을 전송하는 거랑 1대의 컴퓨터가 서로 다른 브라우저에서 다른 URL 1개씩 전송하는 거랑 동일하다. 어차피 각 요청은 개별적인 요청으로 취급하기 때문이다.  

- 사용자 설정 

각 URL을 chrome, edge, firefox에서 전송했다. 

```
http://localhost:5000/setuser/Jun
http://localhost:5000/setuser/PinkFloyd
http://localhost:5000/setuser/goodpower
```

user로 Jun, PinkFloyd, goodpower를 설정함. 만약에 user를 설정하지 않은 브라우저에서 `/getuser` URL을 전송한다면 user 값을 확인할 수 없다는 오류가 발생한다. 

- 사용자 확인 

chrome, edge, firefox에 아래의 url을 전송했다.

```
http://localhost:5000/getuser
```

그러면, 각 브라우저에서 아래의 내용이 화면에 출력된다.

```
User values is currently set to: Jun
User values is currently set to: PinkFloyd
User values is currently set to: goodpower
```

각 브라우저에서 `user의 값`이 각각 다르게 출력되는 걸 확인할 수 있다. 

웹앱에서 session 딕셔너리를 이용해서 user의 값을 독립적으로 저장한 것이다. 웹앱은 각 브라우저의 고유 쿠키를 자동으로 설정하므로 각 브라우저에서 확인할 수 있는 고유의 user값이 만들어졌다. session의 기술을 이용한 것이다. 

웹앱 관점에서는 session 딕셔너리에 `고유 쿠키 값을 key`로 사용하는 `여러 user값`이 있는 것이다. 

브라우저 관점에서는 `자신의 고유 쿠키값`에 대응되는 `하나의 user값`이 존재하는 것이다. 

### 세션으로 로그인 관리하기 

quick_session.py를 실행하면서 session에 브라우저별로 상태값을 저장할 수 있다는 사실을 확인했다. 

이 사실을 바탕으로 vsearch4web.py 에서 사용자를 제한하는 기능을 추가할 수 있다. 

직접 vsearch4web.py를 이용하기 전에 simple_webapp.py라는 파일을 만들어서 실험한 이후에 작업을 진행하도록 하자. 